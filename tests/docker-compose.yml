version: '3.4'

x-raesenmaeher_dbconfig_env: &rmmtxdbconfig_env
  RMMTX_DATABASE_NAME: &rmmtxdbname raesenmaeher
  RMMTX_DATABASE_HOST: postgres
  RMMTX_DATABASE_USER: &rmmtxdbuser raesenmaeher
  RMMTX_DATABASE_PASSWORD: &rmmtxdbpass raesenmaehertestpwd # pragma: allowlist secret


x-postgres_env: &postgres_env
  POSTGRES_PASSWORD: "FIXME: change to long random" # pragma: allowlist secret
  RMMTX_PASSWORD: *rmmtxdbpass # pragma: allowlist secret

services:

  postgres:
    image: postgres:12
    volumes:
      - ./pg_init:/docker-entrypoint-initdb.d
      - pg_data:/var/lib/postgresql/data
    networks:
      - intranet
    ports:
      - '5742:5432'
    environment:
      <<: *postgres_env
    healthcheck:
      test: "pg_isready --dbname=$$POSTGRES_DB --username=$$POSTGRES_USER || exit 1"
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s


networks:
  intranet:

volumes:
  pg_data:
